<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/boycott/bittee-logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bittee â€“ Falasteeni</title>
    <script type="module">
      console.log('Root index.html script executing...');
      const isDev = window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1');
      const isGitHubPages = window.location.hostname.includes('github.io');
      
      console.log('Environment:', { isDev, isGitHubPages, pathname: window.location.pathname });
      
      if (isDev) {
        // Development: load source file directly
        console.log('Loading development file: /src/main.ts');
        const script = document.createElement('script');
        script.type = 'module';
        script.src = '/src/main.ts';
        script.onerror = (e) => {
          console.error('Failed to load /src/main.ts:', e);
          document.getElementById('app').innerHTML = '<div style="color: white; padding: 20px;">Failed to load game. Check console.</div>';
        };
        document.head.appendChild(script);
      } else if (isGitHubPages) {
        // Production on GitHub Pages
        console.log('Fetching /boycott/index.html...');
        fetch('/boycott/index.html')
          .then(response => {
            console.log('Fetch response:', response.status, response.statusText);
            if (response.ok) {
              return response.text();
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          })
          .then(html => {
            console.log('Fetched HTML, parsing...');
            console.log('HTML content (first 500 chars):', html.substring(0, 500));
            
            // Parse the HTML to find script and link tags
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const scripts = doc.querySelectorAll('script[type="module"]');
            // Try multiple selectors for stylesheets
            const links = doc.querySelectorAll('link[rel="stylesheet"], link[rel*="stylesheet"]');
            
            console.log(`Found ${scripts.length} scripts and ${links.length} stylesheets`);
            
            // Also check all link tags
            const allLinks = doc.querySelectorAll('link');
            console.log(`Total link tags found: ${allLinks.length}`);
            allLinks.forEach((link, i) => {
              console.log(`Link ${i + 1}:`, {
                href: link.getAttribute('href'),
                rel: link.getAttribute('rel'),
                crossorigin: link.getAttribute('crossorigin'),
                type: link.getAttribute('type')
              });
            });
            
            // Log what we found
            scripts.forEach((script, i) => {
              console.log(`Script ${i + 1}:`, {
                src: script.getAttribute('src'),
                crossorigin: script.getAttribute('crossorigin'),
                type: script.getAttribute('type')
              });
            });
            
            links.forEach((link, i) => {
              console.log(`Stylesheet ${i + 1}:`, {
                href: link.getAttribute('href'),
                rel: link.getAttribute('rel'),
                crossorigin: link.getAttribute('crossorigin')
              });
            });
            
            // Add stylesheets first
            links.forEach((link, index) => {
              const href = link.getAttribute('href');
              console.log(`Loading stylesheet ${index + 1}:`, href);
              
              const newLink = document.createElement('link');
              newLink.rel = 'stylesheet';
              newLink.href = href;
              if (link.hasAttribute('crossorigin')) {
                newLink.crossOrigin = link.getAttribute('crossorigin') || 'anonymous';
              }
              newLink.onerror = (e) => {
                console.error(`Failed to load stylesheet ${index + 1}:`, href, e);
              };
              newLink.onload = () => {
                console.log(`Stylesheet ${index + 1} loaded:`, href);
              };
              document.head.appendChild(newLink);
            });
            
            // Add scripts
            scripts.forEach((script, index) => {
              const scriptSrc = script.getAttribute('src');
              console.log(`Loading script ${index + 1}:`, scriptSrc);
              
              const newScript = document.createElement('script');
              newScript.type = 'module';
              newScript.src = scriptSrc;
              
              if (script.hasAttribute('crossorigin')) {
                newScript.crossOrigin = script.getAttribute('crossorigin') || 'anonymous';
              }
              
              newScript.onload = () => {
                console.log(`Script ${index + 1} loaded successfully:`, scriptSrc);
                // Check if Phaser is available after a short delay
                setTimeout(() => {
                  if (typeof Phaser !== 'undefined') {
                    console.log('Phaser is now available on window.Phaser!');
                  } else {
                    console.warn('Script loaded but Phaser is still not available on window.Phaser');
                    console.log('This might be normal if Phaser is imported as a module.');
                    console.log('Checking for runtime errors...');
                    
                    // Check if there are any unhandled errors
                    window.addEventListener('error', (event) => {
                      console.error('Unhandled error detected:', event.error, event.message, event.filename, event.lineno);
                    });
                    
                    window.addEventListener('unhandledrejection', (event) => {
                      console.error('Unhandled promise rejection:', event.reason);
                    });
                  }
                }, 1000);
              };
              
              newScript.onerror = (e) => {
                console.error(`Failed to load script ${index + 1}:`, scriptSrc, e);
                document.getElementById('app').innerHTML = `
                  <div style="color: white; padding: 20px; text-align: center; font-family: sans-serif; background: #1c231e; min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <h2>Failed to load game script</h2>
                    <p>Script: ${scriptSrc}</p>
                    <p style="font-size: 14px; color: #888; margin-top: 20px;">
                      Check browser console and Network tab for details.
                    </p>
                  </div>
                `;
              };
              
              // Also catch any errors during script execution
              window.addEventListener('error', (event) => {
                if (event.filename && event.filename.includes('index-')) {
                  console.error('Error in game script:', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    error: event.error
                  });
                  
                  document.getElementById('app').innerHTML = `
                    <div style="color: white; padding: 20px; text-align: center; font-family: sans-serif; background: #1c231e; min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                      <h2>Error in game script</h2>
                      <p style="font-family: monospace; font-size: 12px; color: #ff6b6b; margin: 10px 0;">
                        ${event.message}
                      </p>
                      <p style="font-size: 14px; color: #888; margin-top: 20px;">
                        File: ${event.filename}<br/>
                        Line: ${event.lineno}
                      </p>
                    </div>
                  `;
                }
              }, true); // Use capture phase to catch errors early
              
              document.head.appendChild(newScript);
            });
            
            if (scripts.length === 0) {
              throw new Error('No scripts found in built index.html');
            }
            
            // Wait a bit and check if game initialized
            setTimeout(() => {
              const app = document.getElementById('app');
              const hasContent = app && (app.children.length > 0 || (app.textContent && app.textContent !== 'Initializing...'));
              
              console.log('Checking game initialization...', {
                hasContent,
                childrenCount: app?.children.length || 0,
                textContent: app?.textContent?.substring(0, 50) || 'empty',
                phaserAvailable: typeof Phaser !== 'undefined'
              });
              
              if (!hasContent && (app?.textContent === 'Initializing...' || !app?.textContent)) {
                console.warn('Game may not have initialized. Checking for errors...');
                // Check if Phaser is loaded
                if (typeof Phaser === 'undefined') {
                  document.getElementById('app').innerHTML = `
                    <div style="color: white; padding: 20px; text-align: center; font-family: sans-serif; background: #1c231e; min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                      <h2>Game not initializing</h2>
                      <p>Phaser library not loaded. Check console for errors.</p>
                      <p style="font-size: 14px; color: #888; margin-top: 20px;">
                        Script was loaded but game didn't start.<br/>
                        Check Network tab to see if script file loaded successfully.
                      </p>
                    </div>
                  `;
                }
              }
            }, 3000);
            
            if (scripts.length === 0) {
              throw new Error('No scripts found in built index.html');
            }
          })
          .catch(error => {
            console.error('Failed to load built files:', error);
            document.getElementById('app').innerHTML = `
              <div style="color: white; padding: 20px; text-align: center; font-family: sans-serif; background: #1c231e; min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <h2>Game not loading</h2>
                <p>Error: ${error.message}</p>
                <p style="font-size: 14px; color: #888; margin-top: 20px;">
                  Please check:<br/>
                  - GitHub Actions tab: Is deployment complete?<br/>
                  - GitHub Pages Settings: Source should be "GitHub Actions"<br/>
                  - Try hard refresh (Ctrl+Shift+R or Cmd+Shift+R)<br/>
                  - Check browser console for more details
                </p>
              </div>
            `;
          });
      } else {
        console.log('Unknown environment, showing error');
        document.getElementById('app').innerHTML = `
          <div style="color: white; padding: 20px; text-align: center; font-family: sans-serif; background: #1c231e; min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <h2>Unknown environment</h2>
            <p>Hostname: ${window.location.hostname}</p>
          </div>
        `;
      }
    </script>
  </head>
  <body>
    <div id="app">Initializing...</div>
  </body>
</html>
